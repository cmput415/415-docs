\documentclass{article}

\usepackage{hyperref} % Almost certainly will need
\usepackage{fullpage} % Good for making PDFs as well
\usepackage{listings} % Needed to insert code
\usepackage{lstautogobble}

\usepackage[T1]{fontenc}
% This makes it so the web pages don't have indents as most of the time
% they are just annoying
\setlength{\parindent}{0pt}

\usepackage{textcomp}
\lstset{
  upquote=true,
  basicstyle = \ttfamily,
  columns=fullflexible
  escapeinside=||,
  autogobble
}



% This section allows for tex4ht only control statements
% From http://tex.stackexchange.com/questions/93852/what-is-the-correct-way-to-check-for-latex-pdflatex-and-html-in-the-same-latex
\makeatletter
\edef\texforht{TT\noexpand\fi
  \@ifpackageloaded{tex4ht}
    {\noexpand\iftrue}
    {\noexpand\iffalse}}
\makeatother

\newcommand{\code}[1]{\texttt{\textmd{#1}}}
\newcommand{\assertion}[2]{\textbf{Assertion: }#1 (\hyperlink{#2}{#2})}
\newcommand{\assertionref}[1]{\hyperlink{#1}{#1}}
\newcommand{\assertiondest}[1]{\hypertarget{#1}{\textbf{#1}:}}
\newcommand{\clarification}[2]{\textbf{Clarification: }#1 (\hyperlink{#2}{#2})}
\newcommand{\clarificationdest}[1]{\hypertarget{#1}{\textbf{#1}:}}

\usepackage[usenames]{color}
\newif\ifComments
\Commentstrue

\ifComments
\newcommand{\todo}[1]{\noindent\textcolor{red}{{#1}}}
\newcommand{\chek}[1]{\noindent\textcolor{red}{Check: {#1}}}
\newcommand{\nelson}[1]{\noindent\textcolor{blue}{Nelson: {#1}}}
\newcommand{\marcus}[1]{\noindent\textcolor{BurntOrange}{Marcus: {#1}}}
\else
\newcommand{\todo}[1]{}
\newcommand{\chek}[1]{}
\newcommand{\nelson}[1]{}
\newcommand{\marcus}[1]{}
\fi

\begin{document}

% This is an SCalc of using a switch to have pdf/html only code
\ifpdf
  \LARGE
  \textbf{SCalc}
  \normalsize
\fi

The goal of this assignment is to implement a compiler for a simple imperative language called
\textit{SCalc}. This compiler will directly generate code for the following three backends:
\begin {itemize}
  \item \textit{x86} assembly
  \item \textit{MIPS} assembly
  \item \textit{ARM} assembly
\end {itemize}
You must also create an \textit{interpreter} for \textit{SCalc}

For the interpreter you will be computing the value of the expressions as you traverse the tree.
However, when generating assembly code for each of the backends \textbf{you are not allowed to
perform any computations in the compiler}. You must create assembly code to perform the all of the
computations that appear in the input file.

\textit{MIPS} assembly will be run using \textit{SPIM}\\
\textit{x86} assembly will be assembled using the nasm assembler and run natively.\\
\textit{ARM} assembly will be compiled using the \textit{ARM} toolchain (assembler
\code{arm-none-eabi-as}, linker \code{arm-none-eabi-gcc}) and then run using an \textit{ARM}
simulator (\textit{qemu-arm}).

Your compiler will produce the assembly text files, not binaries. \textbf{You must generate your
assembly using \href{https://github.com/pantor/inja}{inja}}. Inja is a string template engine which
allows you to make use of formatted strings. Its syntax is similar to \textit{Python}'s jinja. You
won't need any advanced features to complete this assignment.

Beyond this constraint you are allow to use any internal representation that you wish, as well as
emit any code that you wish, as long as the output is correct.

\section{Language Specification}
\textit{SCalc} has integer variables, \code{if} statements, loops, prints, and various integer expressions.
\subsection{Reserved Keywords}
The following Keywords are reserved in \textit{SCalc}
\begin {itemize}
  \item{\code{if}}
  \item{\code{fi}}
  \item{\code{loop}}
  \item{\code{pool}}
  \item{\code{int}}
  \item{\code{print}}
\end {itemize}

\subsection {Integer Literals}
In this assignment integer literals are defined as being a string that contains only the numeral 0-9 with no spaces.

\assertion{All integer literals will be positive.}{positive-literals}\\

Examples of valid integers:
\begin{lstlisting}
  1
  123
  5234
  01
  10
\end{lstlisting}

Examples of invalid integers:
\begin{lstlisting}
  1.0
  one
  1_1
  1o
\end{lstlisting}

\subsection{Identifiers}
For the purpose of this assignment, identifiers are simple. They must start with an alphabetical
character. This character may be followed by numbers or alphabetical characters. A keyword cannot
be used as an identifier.

Examples of valid identifiers:
\begin{lstlisting}
  hello
  h
  h3llo
  Hi
  h3
\end{lstlisting}

Examples of invalid identifier:
\begin{lstlisting}
  3d
  a-bad-variable-name
  no@twitter
  we.don't.like.punctuation
  or_spelling
\end{lstlisting}

\subsection{Expressions}
An expression is composed of integers, identifiers, and integer mathematical operations.

\subsubsection{Operators}

\begin{center}
  \begin{tabular}{|c|l|c|l|c|}
    \hline
    \textbf{Class} & \textbf{Operation} & \textbf{Symbol} & \textbf{Usage} &
    \textbf{Associativity} \\
    \hline
    Arithmetic
    &addition      & + & \texttt{expr + expr} & left \\
    &subtraction    & - & \texttt{expr - expr} & left \\
    &multiplication & * & \texttt{expr * expr} & left \\
    &division       & / & \texttt{expr / expr} & left \\
    \hline
    Comparison
    &less than      & <  & \texttt{expr < expr}  & left \\
    &greater than   & >  & \texttt{expr > expr}  & left \\
    &is equal       & == & \texttt{expr == expr} & left \\
    &is not equal   & != & \texttt{expr != expr} & left \\
    \hline
  \end{tabular}
\end{center}

\clarification{There is no remainder operator in SCalc.}{no-rem}\\
\clarification{There is no exponentiation operator in SCalc.}{no-pow}

\subsubsection{Valid Expressions}
Valid formats for expressions are
\begin{lstlisting}
  (<expr>)
  <expr> <op> <expr>
  <int>
  <id>
\end{lstlisting}

\begin{itemize}
  \item \code{expr} is an expression.
  \item \code{int} is an integer.
  \item \code{id} is the identifier of a variable.
\end{itemize}

\assertion{All expressions will result in a value that fits in a 32 bit signed integer.}
{expression-size}\\
\assertion{No expression will contain a division by 0.} {zero-divide}

Examples of valid expressions are
\begin{lstlisting}
  i * 2 * 10 + 4
  2 ^ 4 * 5
\end{lstlisting}

\subsubsection{Comparison Operators}
If a comparison expression evaluates to true then it returns 1. If it evaluates to false then it
returns 0. For example:
\begin{lstlisting}
  print(1==2);
  print(8==8);
\end{lstlisting}
should print:
\begin{lstlisting}
  0
  1
\end{lstlisting}

\subsubsection{Precedence}
Precedence determines what order operations are evaluated in. Precedence works as defined in the
following table:
\begin{center}
  \begin{tabular}{|c|c|}
  \hline
  \textbf{Precedence} & \textbf{Operations} \\
  \hline
  HIGHER
  & *,/ \\
  & +,- \\
  & <, > \\
  LOWER & ==, != \\
  \hline
  \end{tabular}
\end{center}

\subsection {Statements}

In \textit{SCalc} there are five types of statements:

\begin {itemize}
  \item \hyperref[sssec:declaration]{declaration}
  \item \hyperref[sssec:assignment]{assignment}
  \item \hyperref[sssec:conditional]{conditional}
  \item \hyperref[sssec:loop]{loop}
  \item \hyperref[sssec:print]{print}

\end {itemize}

Each statement ends with a semicolon. White space is not important in \textit{SCalc}.

\assertion{Whitespace is guaranteed to be a space, a tab, a carriage return, or a new
line.}{simple-whitespace}

\subsubsection{Declaration}
\label{sssec:declaration}
A variable declaration in \textit{SCalc} has the following form:
\begin{lstlisting}
  int <id> = <expr>;
\end{lstlisting}

\begin{itemize}
  \item \code{id} is the identifier of a variable.
  \item \code{expr} is an expression.
\end{itemize}

Variables have a few properties:\hypertarget{variable-props}{}
\begin{itemize}
  \item cannot be used before being declared.
  \item cannot be declared without initialisation.
  \item cannot be declared more than once in an \textit{SCalc} program.
\end{itemize}

Examples of valid declarations are:
\begin{lstlisting}
  int i = 9;
  int j = 9 * 4 + 10;
  int k = i * j;
\end{lstlisting}

Examples of invalid declarations are:
\begin{lstlisting}
  int i;
  int j =;
\end{lstlisting}

\subsubsection{Assignment}
\label{sssec:assignment}
Variable assignment is similar to variable declaration but it allows variables to be assigned new
values. An assignment in \textit{SCalc} has the following form:
\begin{lstlisting}
  <id> = <expr>;
\end{lstlisting}

\begin{itemize}
  \item \code{id} is the identifier of an already declared variable.
  \item \code{expr} is an expression.
\end{itemize}

\subsubsection{Conditional}
\label{sssec:conditional}
A conditional in \textit{SCalc} has the following form:
\begin{lstlisting}
  if (<expr>)
    <statement-1>
    <statement-2>
    ...
    <statement-n>
  fi;
\end{lstlisting}

\begin {itemize}
  \item
    \code{expr} is an expression. The body of the \code{if} statement is executed if and only if
    this expression evaluates to a non-zero value.
  \item
    \code{statement-*} is any type of statement \textit{except} a declaration. This means there can
    be assignments, nested loops, nested conditionals, and prints. There does not have to be any
    statements in the conditional.
\end{itemize}

\clarification{Declarations in conditionals can lead to undefined values due to global scoping.}
{no-decl-cond}

\subsubsection{Loop}
\label{sssec:loop}
A loop in \textit{SCalc} has the following form:
\begin{lstlisting}
  loop (expr)
    <statement-1>
    <statement-2>
    ...
    <statement-n>
  pool;
\end{lstlisting}

\begin {itemize}
  \item
  \code{expr} is an expression. The body of the \code{loop} statement is repeatedly evaluated as
  long as this expression is non-zero. The expression is evaluated prior to running the body
  similar to a \textit{C} \code{while} loop.
  \item
    \code{statement-*} is any type of statement \textit{except} a declaration. This means there can
    be assignments, nested loops, nested conditionals, and prints. There does not have to be any
    statements in the loop, but without side effects a loop will be infinite (unless it is never
    entered).
\end{itemize}

\clarification{Declarations in loops can lead to undefined or repeatedly defined values due to
global scoping.} {no-decl-loop}

\subsubsection{Print}
\label{sssec:print}
Print statements print the integer value of an expression followed by a newline. A print statement
in \textit{SCalc} has the following form:
\begin{lstlisting}
  print(<expr>);
\end{lstlisting}

\begin{itemize}
  \item \code{expr} is an expression.
\end{itemize}

For example, the input:
\begin{lstlisting}
  int i = 0;
  loop (i < 5)
    print(i);
    i = i + 1;
  pool;
\end{lstlisting}
should print:
\begin{lstlisting}
  0
  1
  2
  3
  4
\end{lstlisting}

\section{Backends}

\textit{SCalc}. This compiler will directly generate code for the following three backends:
\begin {itemize}
  \item \textit{x86} assembly
  \item \textit{MIPS} assembly
  \item \textit{ARM} assembly
\end {itemize}
You must also create an \textit{interpreter} for \textit{SCalc}

\subsection{MIPS}
We recommend that you implement variables in the \code{.data} segment of your assembly code using \code{.word} entries. The
general syntax for MIPS assembly is as follows:

\begin{lstlisting}
  .data
  _newline: .asciiz "\n"
  var1: .word 0
  var2: .word 0
  ...

  .text
  main:
     <your generated code goes here>
     li   $v0, 10
     syscall
\end{lstlisting}

This reference has a \href{http://students.cs.tamu.edu/tanzir/csce350/reference/syscalls.html}
{table of syscalls}. To print integers you should use the print int syscall (\code{1}). To print
strings, you should use the print string syscall (\code{4}) in combination with the address of a
string you've defined in the \code{.data} section containing only a new line character (see above).

If you save the \textit{MIPS} output as \code{program.s} then you can run it with the command:
\begin{lstlisting}
  spim -file program.s
\end{lstlisting}

If you wish to debug you may also launch spim with the command:
\begin{lstlisting}
  spim
\end{lstlisting}
and then at the spim prompt you can load your file with:
\begin{lstlisting}
  load "program.s"
\end{lstlisting}
The double quotes are necessary. You can type \texttt{help} to see the commands that spim provides.

\subsection{x86}
You should use the Intel syntax for \textit{x86}, and your compiler's output must work with the
nasm assembler. Your \textit{x86} output should look something like this:

\begin{lstlisting}
  global main
  extern printf

  section .data
  var1: DD 0
  var2: DD 0
  ...

  section .text
    main:
      <your generated code goes here>
      mov eax, 0 ; Set return value
      ret        ; Return
\end{lstlisting}

Print will use \code{printf}, which we will link in later to make it easier to implement the
\code{print} statement. Printing consists of three steps:
\begin{enumerate}
  \item Push the arguments onto the stack in reverse order.
  \item Call \code{printf}.
  \item Clean up the stack.
\end{enumerate}

For instance, the following segment of code contains a call to \code{printf}:
\begin{lstlisting}
  global main
  extern printf
  section .data
  _format_string: DB "Hello! Here is a number: %d",0xA,0x0

  section .text
    main:
      push dword 7        ; Second argument
      push _format_string ; First argument (remember stacks are FILO)
      call printf         ; Make the call to printf
      add esp, 8          ; Pop the stack, we are done!

      mov eax, 0
      ret
\end{lstlisting}

\code{\_format\_string} deserves a quick explanation. The \code{DB} declares a datatype of bytes,
which is appropriate for characters. The string is converted to its character components and
placed at the label. The values in commas after it are appended to the array. \code{0xA} is the
\href{http://www.asciitable.com/}{ASCII value of a newline in hexadecimal}. The \code{0x0} is the
\href{https://en.wikipedia.org/wiki/Null-terminated_string}{null terminator} for the string.

You won't need to know more of the \textit{x86} calling conventions than what was demonstrated
above.

If you save the \textit{x86} output as \code{program.s} you can assemble an executable and run it
by executing the following commands:
\begin{lstlisting}
  nasm -felf program.s
  gcc program.o -o program -m32
  ./program
\end{lstlisting}

Try this on the \code{printf} example and make sure that it works!

  \subsection{ARM}

    The \textit{ARM} assembly output should look something like this:

    \begin{lstlisting}
      .arch armv7-a
      .data
      _format_string: .asciz "%d\n"
      var1: .word 0
      var2: .word 0
      ...

      .text
      .globl main
      main:
        <your generated code goes here>
        mov r0, #0
        mov r1, #1
        swi 0
    \end{lstlisting}

    We will also be using printf with \textit{ARM}. The \textit{ARM} calling convention is different: the first
    argument is passed in r0, and the second argument is passed in r1. The following code demonstrates a call to
    printf in \textit{ARM} assembly:

    \begin{lstlisting}
      .arch armv7-a
      .data
      _format_string: .asciz "Hello! Here is a number: %d\n"

      .text
      .globl main
      main:
        push {ip, lr}
        ldr r0, =_format_string
        mov r1, #7
        bl printf
        mov r0, #0
        pop {ip, lr}

        mov r0, #0
        mov r1, #1
        swi 0
    \end{lstlisting}

    Aside from the difference calling convention this code is very similar to the \textit{x86} example.

    \textit{ARMv7-A} lacks a division instruction. Therefore, we have to call the subroutine
    \texttt{\_\_aeabi\_idiv} to perform integer division:

    \begin{lstlisting}
      .arch armv7-a
      .data

      .text
      .globl main
      main:
        mov r0, #5
        mov r1, #3
        bl __aeabi_idiv(PLT)  /* Divide 5 by 3, return the result in r0 */

        mov r1, #1
        swi 0
    \end{lstlisting}

    In order to assemble an executable you may run the following commands:

    \begin{lstlisting}
      arm-none-eabi-as -o program.o program.s
      arm-none-eabi-gcc -spec=rdimon.specs -o program program.o
    \end{lstlisting}

    Given an assembly file \texttt{program.s} this sequence of commands will produce an executable called
    \texttt{program} that you can run on the lab machines as follows:

    \begin{lstlisting}
      qemu-arm ./program
    \end{lstlisting}

    Try this on the \texttt{printf} example and make sure that it works!


  \subsection{Interpreter}

    You should be able to execute a program without compiling by implementing an interpreter as well. This should
    work similarly to the generator assignment.

\section{Assertions}
\textbf{ALL} input test cases will be valid. It can be a good idea to do error checking for your
own testing and debugging, but it is \textit{not necessary}. If you encounter what you think is
undefined behaviour or think something is ambiguous then \textit{do} make a forum post about it to
clarify.

What does it mean to be valid input? See these rules:
\begin{enumerate}
  \item
    \assertiondest{undef-behaviour}
    A test case \textit{will not} take advantage of undefined behaviour. Undefined behaviour is
    functionality that does not have an outcome described explicitly by this specification.
  \item
    \assertiondest{positive-literals}
    All integer literals will be positive. For example, the following tests would be considered
    invalid:
    \begin{lstlisting}
      int i = -1;
    \end{lstlisting}
  \item
    \assertiondest{literal-size}
    All integer literals will fit in 31 unsigned bits. This means an integer literal can be
    anywhere in the range $[0, 2^{31} - 1]$ or $[0, 2147483647]$. For example, the following tests
    would be considered invalid:
    \begin{lstlisting}
      int i = 2147483648;
    \end{lstlisting}
  \item
    \assertiondest{expression-size}
    All expressions will result in a value that will fit in 32 signed bits. This means the result
    of an expression can be anywhere in the range $[-2^{31}, 2^{31} - 1]$ or $[-2147483648,
    2147483647]$. Any operation that results in underflow or overflow will render the input
    invalid. For example, the following tests would be considered invalid:
    \begin{lstlisting}
      int i = 2147483647 + 1;
      int j =  0 - 2147483647 - 2;
    \end{lstlisting}
  \item
    \assertiondest{zero-divide}
    No expression will contain a division by 0. The result of a division by zero is indeterminate
    so we will not handle it. For example, the following tests would be considered invalid:
    \begin{lstlisting}
      int i = 1 / 0;
      int j = 1 / (1 - 1);
    \end{lstlisting}
  \item
    \assertiondest{simple-whitespace}
    Whitespace is guaranteed to be a space, a tab, a carriage return, or a new
    line. Any other whitespace characters will render the input invalid. The following ANTLR rule
    will ensure you adhere to this:
    \begin{lstlisting}
      WS: [ \t\r\n]+ -> skip;
    \end{lstlisting}
\end{enumerate}

\section{Clarifications}
These clarifications are meant to add more information to the specification without cluttering it.
\begin{enumerate}
  \item
    \clarificationdest{no-rem}
    There is no remainder operator in SCalc. For example, the following tests would be considered
    invalid:
    \begin{lstlisting}
      int i = 5 % 2;
    \end{lstlisting}
  \item
    \clarificationdest{no-pow}
    There is no exponentiation operator in SCalc. For example, the following tests would be
    considered invalid:
    \begin{lstlisting}
      int i = 2 ^ 2;
    \end{lstlisting}
  \item
    \clarificationdest{no-decl-cond}
    Declarations in conditionals can lead to undefined values due to global scoping.  Because of
    the potentially conditional nature of the execution, it is possible to violate the property of
    variables stating that \hyperlink{variable-props}{variables must be \textit{defined} before
    being used} (not just declared) by never executing the definition. For example, the following
    test would break this property and is therefore invalid:
    \begin{lstlisting}
      if (1 < 0)
        int i = 0;
      fi
      int j = i;
    \end{lstlisting}
  \item
    \clarificationdest{no-decl-loop}
    Declarations in loops can lead to undefined or repeatedly defined values due to global scoping.
    Because of the potentially conditional nature of the execution, it is possible to violate the
    property of variables stating that \hyperlink{variable-props}{variables must be
    \textit{defined} before being used} (not just declared) by never executing the definition. For
    example, the following test would break this property and is therefore invalid:
    \begin{lstlisting}
      loop (1 < 0)
        int i = 0;
      pool
      int j = i;
    \end{lstlisting}
    As well, because of the potentially repeated nature of the execution, it is possible to violate
    the property of variables stating that \hyperlink{variable-props}{variables can only be defined
    \textit{once}} by repeating the declaration. For example, the following test would break this
    property and is therefore invalid:
    \begin{lstlisting}
      int i = 0;
      loop (i < 2)
        int j = 0;
        i = i + 1;
      pool
    \end{lstlisting}
\end{enumerate}

\section{Provided Frameworks}

  The following tools have been provided for you to make development and testing easier

  \subsection{Project Layout}

    For the tools provided to work your project should be in the specified layout. You must provide a \texttt{Main.java} that contains your main function. The program should take two command line arguments. The first argument is the mode that your program should run in. The second is the input file. Your program will output the interpreted results of the input or the assembler matching the mode chosen. The modes will be one of the following \texttt{mips}, \texttt{arm}, \texttt{x86} or \texttt{interpret}.

    \begin{lstlisting}
      +-- project/
        +-- Makefile
        +-- test_script
        +-- src/
          +-- Main.java  (must contain main function)
          +-- *.g4  (Antlr4 lexer/parser source files)
          +-- *.java  (Java source files)
          +-- *.stg  (StringTemplate string template group files)
        +-- TestFiles/
          +-- Input/
            +-- (testfiles)
            ...
          +-- Output/
            +-- (matching output files. Names must match between input test and output test)
            ...
    \end{lstlisting}


  \subsection{Makefile}

    The \texttt{Makefile} provided is an exact copy of the one that will be used for grading.  Any changes made to
    this makefile will not exist in the one used for grading so as a rule of thumb don't change it. The project must
    be in the specified layout for the makefile to properly work (see \texttt{Project Layout})

    The makefile has the following commands:

    \begin{itemize}
      \item{\textbf{all}}: Builds all solution files
      \item{\textbf{run}}: Runs the solution (builds solution if necessary)
      \item{\textbf{arm}}: Runs the solution in arm mode (builds solution if necessary)
      \item{\textbf{mips}}: Runs the solution in mips mode (builds solution if necessary)
      \item{\textbf{x86}}: Runs the solution in x86 mode (builds solution if necessary)
      \item{\textbf{interpret}}: Runs the solution in interpret mode (builds solution if necessary)
      \item{\textbf{test}}: Runs testing system against solution (builds solution if necessary)
      \item{\textbf{clean}}: Cleans all generated files including Intellij generated files
      \item{\textbf{submissible}}: Collects files for submission and places them in a tar ball. This file contains
      the files in the format they should be in
    \end{itemize}

  \subsection{scalc\_tester}

    This program runs all your test files against their matching outputs. This program is designed to operate in the
    same manor as how the marking script will test solutions.

    Help for scalc tester can be found by running with the -h flag:

    \begin{lstlisting}
      ./test_script -h
    \end{lstlisting}

    It by default expects that all input Tests are in \texttt{TestFiles/Input/} and that  all output files are in
    \texttt{TestFiles/Output/}




\section{Tips and Hints}

  \begin{enumerate}
    \item Write tests \textbf{BEFORE} you implement the things they will test. The testing script provided was
    designed to handle failed test cases.  The following command-line flags might be useful when you are running your own tests:
    \begin{description}
      \item[{\tt -a}] turn off stopping on invalid output
      \item[{\tt -s}]  turn off displaying erroneous output
    \end{description}
    \item The antlr4 visitor method is better than the listener method to create the interpreter.
    \item The MIPS, ARM, and x86 compilers can be built using either method. We suggest that you try the listener method.
    \item A single listener or visitor should be able to handle the x86, MIPS, and ARM code generation. All that should
    change is the string template group file used.
    \item There is no specified syntax guide for string template group files, thus you \textbf{CAN} write those files using
    any style that you chose. However, \textbf{software design practices, which include code legibility, form part of your grade}.
    Consistent style throughout your assignment is important.
    \item This assignment will be extended to build a calculator that handles vectors in the next assignment. For that assignment
    you will need to do type checking. Therefore you are advised to:
    \begin {enumerate}
      \item Read that assignment now
      \item Include type checking in this solution, even though you are only
      required to handle integers in this assignment.
    \end {enumerate}
  \end{enumerate}

\end{document}
