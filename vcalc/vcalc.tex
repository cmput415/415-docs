\documentclass{article}

\usepackage{hyperref} % Almost certainly will need
\usepackage{fullpage} % Good for making PDFs as well
\usepackage{listings} % Needed to insert code
\usepackage{lstautogobble}

\usepackage[T1]{fontenc}
% This makes it so the web pages don't have indents as most of the time
% they are just annoying
\setlength{\parindent}{0pt}

\usepackage{textcomp}
\lstset{
  upquote=true,
  basicstyle = \ttfamily,
  columns=fullflexible
  escapeinside=||,
  autogobble
}

% --- This section allows for tex4ht only control statements
% From http://tex.stackexchange.com/questions/93852/what-is-the-correct-way-to-check-for-latex-pdflatex-and-html-in-the-same-latex
\makeatletter
\edef\texforht{TT\noexpand\fi
  \@ifpackageloaded{tex4ht}
    {\noexpand\iftrue}
    {\noexpand\iffalse}}
\makeatother
% -----------------------------------------------------------------------------

\newcommand{\code}[1]{\texttt{\textmd{#1}}}
\newcommand{\clarification}[2]{\textbf{Clarification: }#1 (\hyperlink{#2}{#2})}
\newcommand{\clarificationdest}[1]{\hypertarget{#1}{\textbf{#1}:}}

\usepackage[usenames]{color}
\newif\ifComments
\Commentstrue

\ifComments
\newcommand{\todo}[1]{\noindent\textcolor{red}{{#1}}}
\newcommand{\chek}[1]{\noindent\textcolor{red}{Check: {#1}}}
\newcommand{\nelson}[1]{\noindent\textcolor{blue}{Nelson: {#1}}}
\newcommand{\marcus}[1]{\noindent\textcolor{BurntOrange}{Marcus: {#1}}}
\else
\newcommand{\todo}[1]{}
\newcommand{\chek}[1]{}
\newcommand{\nelson}[1]{}
\newcommand{\marcus}[1]{}
\fi


\begin{document}

% This is an example of using a switch to have pdf/html only code
\ifpdf
  \LARGE
  \textbf{VCalc}
  \normalsize
\fi


This assignment expands the simple calculator, \textit{SCalc}, to build a vector calculator called
\textit{VCalc}. For \textit{VCalc} you need only build an \textit{LLVM IR} back end. None of the
assembly back ends that you built for \textit{SCalc} need to be supported for \textit{VCalc}. An
interpreter is not necessary but can be a good way to ensure that your grammar works as expected.

\section{Language Spec}
\textit{VCalc} is a superset of \textit{SCalc}. \textbf{All operations supported by \textit{SCalc}
must be fully also supported by \textit{VCalc}. All valid \textit{SCalc} programs must run in
\textit{VCalc} without modification.} (The only exceptions are variable names in a \textit{SCalc}
that are now reserved Keywords.) \textit{VCalc} has the additional features discussed in subsequent
section.

\subsection{Keywords}
The following keywords are now also reserved in \textit{VCalc}:
\begin{itemize}
  \item \code{in}
  \item \code{vector}
\end{itemize}

\subsection{Vectors}
\textit{VCalc} has a new type, \code{vector}, that is a vector of integer values. Vectors are
restricted to the length that can be represented by the largest possible range creatable
(\code{(0 - 2147483647 - 1)..2147483647}), therefore they can have a length in the range
$[0, 2^{32}]$. This is because there is no way append to vectors, thus only the largest possible
range must be supported.

There is no way to specify a vector literal, they must be created through ranges, generators, and
filters. The only way to create an empty vector is through the use of a filter whose predicate is
evaluated to false at each index of the domain or a range whose first bound higher is greater  than
the second bound.

\subsection{Range}
In \textit{VCalc} the operator \code{..} is used to generate a vector holding a range of integers.
This operator must have an expression resulting in an integer on both sides of it. These integers
mark the \textit{inclusive} upper and lower bounds of the range.

For example:
\begin{lstlisting}
  print(1..10);
  print((10-8)..(9+2));
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [1 2 3 4 5 6 7 8 9 10]
  [2 3 4 5 6 7 8 9 10 11]
\end{lstlisting}

The number of integers in a range may not be known at compile time when the integer expressions use
variables. In another example, assuming at runtime that \code{i} is computed as -4:
\begin{lstlisting}
  print(i..5);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [-4 -3 -2 -1 0 1 2 3 4 5]
\end{lstlisting}

Therefore, it is \textit{valid} to have bounds that will produce an empty vector because the
difference between them is negative. For example:
\begin{lstlisting}
  int i = 3;
  int j = 0;
  print(i..j);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  []
\end{lstlisting}

\subsection{Generators}
A generator is another way to create a vector in \textit{VCalc}. Generators work the same as they
did in the generator assignment and have the following form:
\begin{lstlisting}
  [<domain variable> in <domain> | <expression>]
\end{lstlisting}
The identifier is referred to as the domain variable, the vector is the domain or domain vector,
and the expression is the right-hand-side expression. The domain variable is an integer typed
variable defined only in the scope of the generator. The domain may be any vector-valued expression
which includes identifiers (that are vector typed), ranges, generators, and filters.

Generators are identical to list comprehensions from other languages. For instance, to generate a
vector of the first 100 perfect squares, one may write the following generator:
\begin{lstlisting}
  [i in 1..100 | i * i]
\end{lstlisting}

The expression on the right yields the value for a single element of the generated vector, which
corresponds to the element \code{i} of the domain vector.

The right-hand-side expression does not need to depend upon the domain variable. For instance:
\begin{lstlisting}
  print([i in 1..10 | 0]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [0 0 0 0 0 0 0 0 0 0]
\end{lstlisting}

As another example, the following generator produces the square value of all positive, even integers
up to 20.
\begin{lstlisting}
  print([i in [ j in 1..10 | j * 2] | i * i]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [4 16 36 64 100 144 196 256 324 400]
\end{lstlisting}

\subsection{Filters}
A filter has similar syntax to a generator, but instead has a \code{\&} instead of a \code{|} as
shown here:
\begin{lstlisting}
  [<domain variable> in <domain> & <predicate>]
\end{lstlisting}
The identifier and vector are still called the domain variable and domain vector and have the same
properties and requirements as in a generator. However, the right-hand-side expression is now a
\textit{predicate}, meaning it will be evaluated as a boolean.

A filter will create a new vector containing only the elements of the domain where the predicate
evaluates to a true value. The domain values that satisfy the predicate are appended to the result
vector in their original order. For instance, to select all of values greater than 5 in a vector
you might do:
\begin{lstlisting}
  print([i in 1..10 & 5 < i ]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [6 7 8 9 10]
\end{lstlisting}

\subsection{Expressions}
\subsubsection{Operators}
Because we've added a new binary operator, we need to update our precedence table. Operators without
a horizontal line dividing them have equal precedence. For example, addition and subtraction have an
equal level of precedence.
\begin{center}
  \begin{tabular}{|c|l|c|l|c|}
    \hline
    \textbf{Class} & \textbf{Operation} & \textbf{Symbol} & \textbf{Usage} &
      \textbf{Associativity} \\
    \hline
    Vector
    &index          & [] & \texttt{expr[expr]} & left \\ \cline{2-5}
    &range          & .. & \texttt{expr .. expr} & left \\
    \hline
    Arithmetic
    &multiplication & * & \texttt{expr * expr} & left \\
    &division       & / & \texttt{expr / expr} & left \\ \cline{2-5}
    &addition      & + & \texttt{expr + expr} & left \\
    &subtraction    & - & \texttt{expr - expr} & left \\
    \hline
    Comparison
    &less than      & <  & \texttt{expr < expr}  & left \\
    &greater than   & >  & \texttt{expr > expr}  & left \\ \cline{2-5}
    &is equal       & == & \texttt{expr == expr} & left \\
    &is not equal   & != & \texttt{expr != expr} & left \\
    \hline
  \end{tabular}
\end{center}

\subsubsection{Binary Operations on Vectors}
Binary oprations between vectors require extra specification.
\begin{enumerate}
  \item
    All binary operations are performed element-wise. This means that the specified operation is
    applied to elements at the same index in both vectors with the result then being placed into the
    same index in the result vector. For example:
    \begin{lstlisting}
      vector v = 1..5 + 1..5;
      print(v);
    \end{lstlisting}

    prints the following:
    \begin{lstlisting}
      [2 4 6 8 10]
    \end{lstlisting}
  \item
    Binary operations \textit{can} be performed between vectors of different sizes. For most
    operations the smaller vector is padded with zeroes to match the larger vectors size and then
    the operation is applied.
    For example:
    \begin{lstlisting}
      print(6..10 + 1..3);
      print(1..3 + 6..10);
    \end{lstlisting}

    prints the following:
    \begin{lstlisting}
      [7 9 11 9 10]
      [7 9 11 9 10]
    \end{lstlisting}

    The only exception is when the smaller vector is a \textit{divisor}. A divisor must be extended
    with ones to prevent division by zero errors. For example:
    \begin{lstlisting}
      print(6..10 / 1..3);
      print(6..8 / 1..5);
    \end{lstlisting}

    prints the following:
    \begin{lstlisting}
      [6 3 2 9 10]
      [6 3 2 0 0]
    \end{lstlisting}
  \item
    Boolean operators between vectors are still applied element-wise, but the result will be
    converted to an integer as decribed in \textit{SCalc} before being saved into the result. For
    example:
    \begin{lstlisting}
      vector a = [i in 0..5 | i / 2];
      vector b = [i in 1..6 | i / 2];
      print(a);
      print(b);
      print(a == b);
    \end{lstlisting}

    prints the following:
    \begin{lstlisting}
      [0 0 1 1 2 2]
      [0 1 1 2 2 3]
      [1 0 1 0 1 0]
    \end{lstlisting}
\end{enumerate}

\subsubsection{Integer to Vector Promotion}
Integers used in expressions with vectors will be promoted to vectors. The scalar value will be
copied into \textit{each index} of a new vector the same size as the other operand before applying
the operator in the regular vector fashion. For example:
\begin{lstlisting}
  print(1..5 + 5);
  print(2 * 3..6);
  print(5 < 3..7);
\end{lstlisting}

 prints the following:
 \begin{lstlisting}
   [6 7 8 9 10]
   [6 8 10 12]
   [0 0 1 1 1]
 \end{lstlisting}

A more complicated example:
\begin{lstlisting}
  print(5 + [i in 1..3 | 0] + 1..5);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [6 7 8 4 5]
\end{lstlisting}

One might expect:
\begin{lstlisting}
  [6 7 8 9 10]
\end{lstlisting}

but recall that addition is left associative. Therefore the order of the operations in the print
statement is:
\begin{lstlisting}
  print((5 + [i in 1..3 | 0]) + 1..5);
\end{lstlisting}

The five will be promoted to a vector of length three to match the generator, resulting in
\code{[5 5 5]}, which will be added to the generator for no change. Then it will be
\textit{extended} to match the length five range as \code{[5 5 5 0 0]} before being added to create
the final result of \code{[6 7 8 4 5]}.

\subsubsection{Vector Indexing}
Vectors can be indexed by a scalar to produce the integer value at a specified index. Vectors in
\textit{VCalc} are \textit{zero indexed}. As well, indexing outside of the bounds of a vector (e.g.
\code{v[i]} where $ 0 <= |v| < l$ and $ i < 0 $ or $ i >= l$) is \textit{not an error}. An
index out of bounds \textit{always returns zero}.

The domain of an index expression does not need to be an identifier, it need only evaluate to a
vector type. Therefore ranges, generators, and filters can be indexed immediately after being
evaluated.

The domain index of an index expression does not need to be a literal.

Examples of valid index expressions:
\begin{lstlisting}
  vector v = 1..5;
  print(v[0 - 1]);
  print(v[2]);
  print(v[5]);
  print([i in v | i * 2][3]);
  print([i in v & i > 2][0]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  0
  3
  0
  8
  3
\end{lstlisting}

Domain vectors can also be indexed by a domain indexing vector to produce a new result vector. This
new vector will contain the values of the domain vector as if each of the values in the domain
indexing vector had individually indexed the domain vector and then been appended to the result
vector. For example:
\begin{lstlisting}
  vector v = 1..7;
  vector i = 2..4;
  print(v[i]);
  print(v[i * 2]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [3 4 5]
  [5 7 0]
\end{lstlisting}

Each value in \code{i} serves as an index into \code{v}. Each value indexed from v is appended to
the result and then printed.

\subsection{Statements}
\subsubsection{Declaration}
\textit{VCalc} adds vectors as an assignable type. To declare a vector variable, you declare a
variable as you would an integer, but replace \code{int} with \code{vector}. Vectors may be
initialized with any expression that returns a vector. For example, assigning a range to a vector
\code{v}:
\begin{lstlisting}
  vector v = 1..10;
  print(v);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  [1 2 3 4 5 6 7 8 9 10]
\end{lstlisting}

\subsubsection{Assignment}
There are a few new important points when dealing with assignments.
\begin{enumerate}
  \item
    The size of a vector may change while the program is executing if a vector variable is assigned
    another value. For instance, the following sequence of statements \textit{is} valid:
    \begin{lstlisting}
      vector v = 1..10;
      v = 1..1000;
    \end{lstlisting}
    You will have to allocate more memory to store the result of the assignment.
  \item
    The type of the expression of the assignment must match the destination variable's type. This
    is apparent for trying to assign vectors to a scalar. In the case of scalars being assigned to
    vectors, one might expect that we can use our extension policy to copy our scalar to every index
    of a newly created vector but the question is, how large is the new vector. Because that is
    indeterminable, this is not allowed. For example, the following sequence of statements
    \textit{is not} valid:
    \begin{lstlisting}
      int i = 1..3;
      vector v = 1;
    \end{lstlisting}
  \item
    Many languages allow you to assign to vector indices, \textit{VCalc does not}. For example, the
    following sequence of statments \textit{is not} valid:
    \begin{lstlisting};
      vector v = 1..3;
      v[0] = 99;
    \end{lstlisting}
\end{enumerate}

\subsection{Type Checking and ASTs}
With the addition of another type that can be mixed in, type checking becomes a necessity in
\textit{Vcalc}. This means ensuring that vectors and scalars are where they belong. Most expressions
allow the interchange of vectors and scalars, but there's a few cases where it is necessary to have
one or the other.
\begin{itemize}
  \item
    Ranges: lower and upper bounds must be integers.
  \item
    Conditional Statements: must be booleans (remember that integers can be implicitly downcast to
    booleans).
  \item
    Domains: in a domain expression (generator, filter, index) the domain must be a vector.
  \item
    Generators: the expression must be an integer (remember that booleans can be implicitly upcast
    integers).
  \item
    Filters: the predicate must be a boolean.
\end{itemize}

A good way to handle this now and plan ahead for \textit{gazprea} is to start building an abstract
syntax tree (AST) from your parse tree as well as a class that knows how to traverse it.

An AST will allow you to attach information in ways that make sense to you. It allows you to strip
away unecessary tokens from the parse tree as well as allowing you to convert the parse tree into a
new form that also makes sense to you. This could mean normalising parts of the tree to reduce code
generation efforts, attaching information through fields or entirely new nodes, and more.

You can create a tree traversal class in the same vein as ANTLR and its BaseVisitors. This way you
can use the same mechanism for manipulating the tree, type checking, or final code generation.

You can find more advice in the AST Tips and Tricks section.

\subsection{Scoping}
Loops and conditionals are scoped in \textit{VCalc}, unlike \textit{SCalc}. As well, generators and
filters both have internal scopes for their domain variable.

A reference to a variable will resolve to the \textit{definition} in the innermost possible scope.
This matches the scoping rules found in \textit{C}. For example:
\begin{lstlisting}
  int i = 1;
  print(i);

  if (1 == 1)
    int i = 3;
    print(i);

    i = i * 2;
    print(i);
  fi;

  print(i);

  loop (i < 20)
    print(i);
    i = i + 10;
  pool;

  print(i);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  1
  3
  6
  1
  1
  11
  21
\end{lstlisting}

Generator and filter scopes only exist during the evaluation of the expression or predicate. The
scope will only contain the domain variable.

Be careful in what order you evaluate things. For example:
\begin{lstlisting}
  int i = 0;
  if (1 == 1)
    int i = i + 1;
    print(i);
  fi;

  vector v = 0..3;
  print([i in i..3 | i]);
  print([v in v & v < 2]);

  int j = 5;
  print([i in v | i * j]);
\end{lstlisting}

prints the following:
\begin{lstlisting}
  1
  [0 1 2 3]
  [0 1]
  [0 5 10 15]
\end{lstlisting}

If you define a variable in a scope before evaluating the expression, you may mis-resolve a value.
If you enter the new scope in your filter or generator before resolving the domain, you may
mis-resolve the domain.

\section{Input}
The input processed by your compiler will be in a file specified on the command line. Your
compiler will be invoked with the following command:
\begin{lstlisting}
  vcalc <input_file_path> <output_file_path>
\end{lstlisting}
You should open the file \code{input\_file\_path} and parse it. The input file will be a valid
vcalc file.

\section{Output}
Output is to be written to a file specified on the command line. Your compiler
will be invoked with the following command:
\begin{lstlisting}
  vcalc <input_file_path> <output_file_path>
\end{lstlisting}
You should open the file \code{output\_file\_path} and write to it. The output file should be
overwritten if it already exists.

Output content is standardized to ensure everyone can pass everyone's tests. Follow these
specifications:
\begin{itemize}
  \item
    There \textit{must} be a new line after each \code{print} statement's printed value.
  \item
    There \textit{must not} be any trailing space after printed value and before the newline.
  \item
    There \textit{must} be an empty line at the end of your output.
  \item
    There \textit{must not} be spaces between the first and last number and the accompanying
    brackets in a vector.
  \item
    There \textit{must} be spaces between the numbers in a vector.
  \item
    There \textit{must not} be anything except spaces between the numbers in a vector.
\end{itemize}

\clarification{Empty input should result in empty output.}{empty-input}\\
\clarification{Empty vectors print only brackets.}{empty-vector}\\
\clarification{A vector with one value is only the brackets and the value.}{single-value-vector}

\section{Clarifications}
These clarifications are meant to add more information to the specification without cluttering it.
\begin{enumerate}
  \item
    \clarificationdest{empty-input}
    Empty input should result in empty output. This is in keeping with all of the output rules
    defined. There are no \code{print} statements so there would be no numbers, newlines or output
    of any kind. All that you are left with is a single empty line, which matches "\textit{should}
    be an empty line at the end of your output".
  \item
    \clarificationdest{empty-vector}
    Empty vectors print only brackets. This is in keeping with all of the output rules defined.
    There are no integers to print between the brackets, so there is no values nor spaces to print.
    For example:
    \begin{lstlisting}
      []
    \end{lstlisting}
  \item
    \clarificationdest{single-value-vector}
    A vector with one value is only the brackets and the value. This is in keeping with all of the
    output rules defined. There is only one integer. There is no space between the first bracket
    and the integer and no space between the integer and the second bracket. For example:
    \begin{lstlisting}
      [1]
    \end{lstlisting}
\end{enumerate}

\section{Getting Started}
This section will help you get started with this assignment.

\subsection{Project Layout}
For the tools provided to work your project should be in the specified layout.
\begin{lstlisting}
  +-- cmake
  |   +-- antlr_generate.cmake
  |   +-- get_antlr.cmake
  |   +-- get_antlr_manual.cmake
  |   +-- get_llvm.cmake
  |   +-- symlink_to_bin.cmake
  +-- CMakeLists.txt
  +-- grammar
  |   +-- VCalc.g4
  +-- include
  |   +-- placeholder.h
  +-- LICENSE.md
  +-- README.md
  +-- scripts
  |   +-- configureLLVM.sh
  +-- src
  |   +-- CMakeLists.txt
  |   +-- main.cpp
  +-- tests
      +-- input
      |   +-- ...
      +-- output
          +-- ...
      +-- VCalcConfig.json
\end{lstlisting}

\subsection{Setting up CLion}
CLion requires a little bit of setup. Much of it is the same, but we need to add LLVM now.
\begin{enumerate}
  \item
    Open up CLion. From the welcome screen select \texttt{Import Project from Sources} or, if
    you've been using CLion and it opens to previous project, from the \texttt{File} menu select
    \texttt{Import Project\ldots}. Navigate to where your project is located an choose it. Choose
    \texttt{Open Project} \textit{not} \texttt{Overwrite CMakeLists.txt}. If you already have a
    project open, you can choose to use your current window or create another one.
  \item
    CLion doesn't make use of your command line environment, it has its own storage place.
    Therefore we need to add \code{ANTLR\_INS} and \code{LLVM\_DIR} to CLion's environment.
    \begin{enumerate}
      \item
        Open your settings. On Linux this is \texttt{File} $\rightarrow$ \texttt{Settings\ldots},
        while on MacOS this is \texttt{CLion} $\rightarrow$ \texttt{Preferences\ldots}.
      \item
        From the left menu, expand \texttt{Build, Execution, Deployment}.
      \item
        Select \texttt{CMake} from the newly expanded options.
      \item
        In the right pane, select the \texttt{\ldots} to the right of the empty text field to the
        right of \texttt{Environment}.
      \item
        In the new pane, select the \texttt{+} symbol to add a new entry in the environment. On
        Linux this is in the top right of the pane, while on MacOS this is in the bottom left of
        the pane.
      \item
        In the new text field under \texttt{Name} enter \code{ANTLR\_INS}. In the field under
        \texttt{Value} enter the path to your \code{antlr\_install} directory. If you've forgotten
        it but your terminal is set up correctly, or if you're using the lab machines, then you can
        enter the following command to print it:
        \begin{lstlisting}
          echo $ANTLR_INS
        \end{lstlisting}
      \item
        Select the \texttt{+} symbol to add another symbol to your environment. In the field under
        \texttt{Name} enter \code{LLVM\_DIR}. Since the value depends on how you have set up your
        environment (or how we have if you're using the lab machines) you will need to enter this
        command in your terminal to find the value.
        \begin{lstlisting}
          echo $LLVM_DIR
        \end{lstlisting}
        Add this value in the \texttt{Value} field.
      \item
        Apply all of your changes while closing the settings.
    \end{enumerate}
  \item
    Make sure you're building the \texttt{all} target, not just the \texttt{scalc} target. From the
    drop down menu in the top right of the IDE you can choose your build target. Change this to
    \texttt{Build All}.
  \item
    CLion may not automatically pick up ANTLR's generated sources as your project's. We can fix
    this by telling CLion where the files are. Build once to have the \code{gen} directory appear
    in the project manager pane. Right click on the directory, near the bottom of the menu find
    \texttt{Mark directory as}, within that menu select \texttt{Project Sources and Headers}.
\end{enumerate}

\section{Deliverables}
Your submission will be \textbf{the latest commit before the deadline} to your github repository.
Your submission will be automatically snapshotted by the GitHub classroom at the submission time.

Do no submit your binaries, they will be built just before being tested. The solutions will be
built using the lab machines. You should make sure your solution builds in a lab environment prior
to the submission time.

Your tests also should be committed to your github repository. We will pull both your submission
and tests directly from your repository.

You do not need to submit anything on eclass or anywhere else.

\section{Tips and Hints}
\begin{enumerate}
  \item
    The learning curve for \textit{LLVM} is not trivial. Thus \textbf{START EARLY}. There will be a
    lot of things to learn. If you can't figure out how to do something don't be afraid to ask.
    Someone else will know or someone else will also want to know.

    As well, you should check the \textit{LLVM} Tips and Hints section for a good starting place.
  \item
    You should definitely consider making an AST in this assignment. While it's not strictly
    necessary it can be a great help, and you'll be much better equipped moving into
    \textit{gazprea}.

    You should check the AST Tips and Hints section for a good starting place here as well.
  \item
    Write tests \textbf{BEFORE} you implement the things they will test.
  \item
    Reuse your tests from \textit{SCalc}.
  \item
    There are times when you do not want to visit the tree in order (e.g. filters/generators), this
    makes using a listener difficult. We suggest using a visitor.
  \item
    Try to plan ahead of time to avoid having to rewrite things. Occasionally you will need to
    rewrite portions of your code if you find a new complication. You can mitigate some of this with
    modular design.
  \item
    Your files in this project can get quite large. Don't be afraid to split them up. Remember that
    you can have multiple implementation files per header file but you should still try to keep
    similar things together.
  \item
    Remember that your style should be consistent. Now that you're in a team you should discuss some
    probably points of code contention to make sure you're on the same page.
  \item
    This is the biggest assignment, thus \textbf{START EARLY}.
    \textbf{DO NOT USE \textit{LLVM IR} VECTOR TYPES}. These types are designed for Single
    Instruction Multiple Data (SIMD) processing. They are also architecture specific on
    implementation. Using the LLVM IR vector types will result in a segmentation fault in
    architectures that do not support them. Not all lab machines support the \textit{LLVM IR}
    vector.
  \item
    The \href{http://releases.llvm.org/6.0.1/docs/tutorial/index.html}{\textit{LLVM} language
    implementation tutorial} can help with some ideas on how to begin codegen. In particular,
    sections three and five are of particular interest. Section 7 is worth looking through for more
    discussion of the use of \code{alloca} over \code{phi} nodes. The other sections can be read at
    your own discrection.
  \item
    The demo that was presented in lab can be found
    \href{https://webdocs.cs.ualberta.ca/\%7Ec415/vcalc/static/labdemo.tar.gz}{here}. Remember to
    set it up in CLion just like you did with your regular project (environment variables).
\end{enumerate}

\section{LLVM Tips and Hints}
This section is likely to be constantly updated as new questions are asked or useful things are
found. You will be notified as appropriate.

\begin{itemize}
  \item
    It may be helpful to find out how \textit{clang} translates equivalent \textit{C} programs into
    \textit{LLVM IR}. You can ask \textit{clang} to output its generated \textit{LLVM IR} via this
    command:
    \begin{lstlisting}
      clang -emit-llvm -S -c test.c
    \end{lstlisting}
    Clang will sometimes optimise unused code away when we would really like to see what it's doing.
    Consider changing to a different optimsation level or disabling it completely (\code{-O0}). As
    well, try printing intermediate values, the program will be forced to evaluate them.

    While you can't use the text directly, it can give you an idea of what instructions are being
    created. The \textit{LLVM} documentation is quite good. If you don't immediately understand an
    instruction, the \textit{LLVM} language reference is a great resource, as is our class forums.
    The instruction generation function is often found under the same name in the IR builder.

    LLVM IR is not static and can change between versions. Often, things are not too different so
    using a different version will not affect you. If things are not working out and you would like
    to be absolutely sure, you can build \textit{clang} yourself or use the executable that has been
    already built for you on the CSC lab machines (need to be sourcing our setup files). We operate
    from the release\_60 branch in the \href{https://github.com/cmput415/clang}{c415 repository}.
    The version command thus produces:
    \begin{lstlisting}
      clang version 6.0.1 (https://github.com/cmput415/clang.git 2f27999df400d17b33cdd412fdd606a88208dfcc) (https://github.com/cmput415/llvm.git 2c9cf4f65f36fe91710c4b1bfd2f8d9533ac01b5)
      Target: x86_64-unknown-linux-gnu
      Thread model: posix
      InstalledDir: /cshome/c415/415-resources/llvmi/bin
    \end{lstlisting}
  \item
    The \textit{LLVM} interface has its own small optimisations built in. Often this is only
    instruction reduction. Be aware that you may find code that you emitted to be missing. The
    easiest to see case is constant folding. If two constants are operated on, the operation will be
    completed before emitting any code and instead you will see only their result as a constant.
  \item
    Sometimes \textit{LLVM} generates unexpected (but correct) code. For example, requesting an
    integer cast can generate a multitude of instructions based on size of operands and signedness.

    For example, an unsigned cast from \code{i1} to \code{i32} will produce a \code{zext} (zero
    extend) instruction while a signed cast with the same types will produce a \code{sext} (sign
    extend) instruction, which is probably not what you want.

    Be careful of downcasting. Asking for a cast from a larger type integer type to a smaller
    integer type will only ever produce a \code{trunc} (truncate) instruction. This is
    \textit{correct} but it's not always what you want.
  \item
    In order to perform some operations, it is a good idea to create a library of functions yourself
    to use internally. These functions compose what is called your runtime. These can be especially
    useful when dealing with vectors and may help to keep your generated code more easily readable.

    For example, rather than generating the necessary guards and final load used in vector indices,
    it may make more sense to create an indexing function to handle this for you, replacing all
    codegen with a simple function call.

    You can make sure there is no naming conflicts by either suffixing or prefixing your internal
    runtime variables or all of the program variables. \textit{LLVM IR} allows \code{.} characters
    in variable names while \textit{VCalc} does not. This allows for easily guaranteed conflict-free
    names.
  \item
    Most instructions generated give you the opportunty to name the result if you want. While you
    don't need to, it can help you debug when things are going wrong.
  \item
    \textit{LLVM} has an automatic way to verify modules for you. It can be a good idea to use it
    just before you output your code to make sure everything makes sense. This can be extremely
    helpful for noticing small errors. Here's a basic invocation for your output using the verifier.
    \begin{lstlisting}
      #include "llvm/IR/Verifier.h"
      #include "llvm/Support/raw_os_ostream.h"
      ...
      llvm::raw_os_ostream llOut(outStream);
      llvm::raw_os_ostream llErr(std::cerr);
      llvm::verifyModule(mymodule, &llErr);
      myModule.print(llOut, nullptr);
    \end{lstlisting}
  \item
    \textbf{DO NOT USE \textit{LLVM IR} VECTOR TYPES}. These types are designed for Single
    Instruction Multiple Data (SIMD) processing which require specific version of processors. Using
    the LLVM IR vector types will result in a segmentation fault in architectures that do not
    support them. Not all lab machines support the \textit{LLVM IR} vector.
  \item
    You will need to divise your own vector type and method of storing data. One way is to use a
    linked list of structs with predefined integer arrays. Another is to \code{malloc}/\code{free}
    memory. Each has their own unique pros and cons.
\end{itemize}

\end{document}


% 1. Enable building in CLion:
%    1. Open settings in CLion (File > Settings).
%    1. Open Build, Execution, Deployment.
%    1. Click "..." beside the Environment field.
%    1. Click the "+" in the top right.
%    1. Set the name to `LLVM_DIR` and the value to
%       `<ABSOLUTE PATH TO INSTALL DIRECTORY>/lib/cmake/llvm`
