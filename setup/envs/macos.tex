\documentclass[../setup.tex]{subfiles}

\begin{document}

\subsection{Installing Developer tools}
It's likely that you've already done this since you're in the Computing Science program, but in the
event that you have a fresh install, run the following command to install Mac OS developer tools:
\begin{lstlisting}
  xcode-select --install
\end{lstlisting}

\subsection{Installing Homebrew}
Homebrew is a package manager for Mac OS X. If you don't have it yet, you can read about it
\href{https://brew.sh/} {here}. Otherwise, install it via the command on their front page:
\begin{lstlisting}
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
\end{lstlisting}
You can check that it succeeded by checking its version:
\begin{lstlisting}
  brew --version
\end{lstlisting}
Homebrew itself is not a requirement, just an easy suggestion, but a package manager is. Using
another package manager (like \href{https://nixos.org/nix/} {Nix}) is fine, as long as you
understand how to install packages.

\subsection{Installing Oracle Java JDK}
Installing from the Oracle download page requires a bunch of extra set up when instead you could
just use our good friend Homebrew to install it (unfortunately you get the JDK not just the JRE).
\begin{lstlisting}
  brew cask install java
\end{lstlisting}

\subsection{Installing Git}
The Apple managed version of git should have been installed with your developer tools, you can test
this by checking the version.
\begin{lstlisting}
  git --version
\end{lstlisting}

(OPTIONAL) If you want a more recent version, you can install one through brew (or your favorite
package manager). At the time of writing this, the versions only differ by two minor versions, so
the difference is not significant.
\begin{lstlisting}
  brew install git
\end{lstlisting}

\subsection{Installing CMake}
Brew (or otherwise) makes this easy:
\begin{lstlisting}
  brew install cmake
\end{lstlisting}

\subsection{ANTLR 4 C++ Runtime}
This section details how to install the ANTLR 4 C++ runtime on Ubuntu assuming your default shell
is bash. If you've changed your shell from bash it's assumed that you are familiar enough with your
environment that you can modify these steps appropriately.
\begin{enumerate}
  \item
    To make things easy, we are going to do everything inside a new directory in your home
    directory.
    \begin{lstlisting}
      mkdir $HOME/antlr
    \end{lstlisting}
    We'll refer to this directory as \lstinline{ANTLR_PARENT}.
  \item
    Next we need to clone the runtime source from GitHub:
    \begin{lstlisting}
      cd $HOME/antlr
      git clone https://github.com/antlr/antlr4.git
    \end{lstlisting}
    This should create a new folder called \lstinline{antlr4} in \lstinline{ANTLR_PARENT}. We'll
    refer to this new directory (\lstinline{<ANTLR_PARENT>/antlr4}) as \lstinline{SRC_DIR}.
  \item
    We will be using ANTLR 4.7.1 so we need to change to the git tag for version 4.7.1.
    \begin{lstlisting}
      cd <SRC_DIR>
      git checkout 4.7.1
    \end{lstlisting}
    This will give you a warning about being in a ``detached head state''. Since we won't be
    changing anything in ANTLR there is no need to create a branch. No extra work is needed here.
  \item
    Now we need a place to build the runtime. CMake suggests making your build directory inside
    your source directory.
    \begin{lstlisting}
      cd <SRC_DIR>
      mkdir antlr4-build
    \end{lstlisting}
    We'll refer to this new directory (\lstinline{<SRC_DIR>/antlr4-build}) as
    \lstinline{BUILD_DIR}.
  \item
    We need to have an install directory prepared before building since it's referenced in the
    build step. This directory will have the headers and compiled ANTLR libraries put into it.
    To make the actual directory:
    \begin{lstlisting}
      cd <ANTLR_PARENT>
      mkdir antlr4-install
    \end{lstlisting}
    We'll refer to this new directory (\lstinline{<ANTLR_PARENT>/antlr4-install}) as
    \lstinline{INSTALL_DIR}.

    Before continuing, confirm your directory structure looks like this:
    \begin{lstlisting}
      +-- antlr/
          +-- antlr4/
          |   +-- antlr4-build/
          +-- antlr4-install/
    \end{lstlisting}
  \item
    Finally, we're ready to start the actual build process. Let's begin by doing the generate and
    configure CMake step for the runtime. We need to do this while inside the build directory. As
    well, we need to tell it that we want a release build and to install it to a certain directory.
    \begin{lstlisting}
      cd <BUILD_DIR>
      cmake <SRC_DIR>/runtime/Cpp/ \
        -DCMAKE_BUILD_TYPE=RELEASE \
        -DCMAKE_INSTALL_PREFIX="<INSTALL_DIR>"
    \end{lstlisting}
    You will be presented with come CMake warnings but they're safe to ignore.
  \item
    We can finally run make to build the library and install it. You can make the process
    significantly faster by running with multiple threads using the \lstinline{-j} option and
    specifying a thread count. Using the option without a count will use all cores. Be careful when
    using unlimited threads, the build has failed in the past. This isn't a big issue because you
    can always just try again with a limited number of threads.
    \begin{lstlisting}
      make install -j<number of threads>
    \end{lstlisting}
  \item
    Now we can add the install to your bash profile. Pick your favorite text editor, open
    \lstinline{~/.bash_profile}, and add the following lines to the end, substituting
    appropriately:
    \begin{lstlisting}
      # C415 ANTLR install
      export ANTLR_INS=<INSTALL_DIR>
    \end{lstlisting}
    \textbf{Make sure there is no trailing /.} Restart your terminal for things to take effect.
\end{enumerate}

\subsection{Installing CLion}
\begin{enumerate}
  \item
    Use Homebrew to install CLion:
    \begin{lstlisting}
      brew cask install clion
    \end{lstlisting}
  \item
    Open CLion (via spotlight: command+space $\rightarrow$ type \texttt{CLion}).
  \item
    Perform the initial set up of CLion.
    \begin{enumerate}
      \item
        Select \texttt{Do not import settings} and click \texttt{OK}.
      \item
        Scroll to the bottom of the license agreement then hit \texttt{Accept}.
      \item
        Choose if you want to share usage statistics.
      \item
        You should be presented with a prompt for your license. Select \texttt{Activate},
        \texttt{JetBrains Account}, enter your UAlberta email address and JetBrains password.
        Click the \texttt{Activate} button.
      \item
        Pick your favorite UI. Then click \texttt{Next: Toolchains}.
      \item
        CLion bundles a version of CMake with it. If you'd prefer to use the one we've just
        installed change \texttt{Bundled} to \lstinline{/usr/local/bin/cmake}. The info text
        beneath should update with a checkmark and the version of your installed cmake. Click
        \texttt{Next: Default Plugins}.
      \item
        You might consider disabling all but the git plugin, and even then, using it is up to you.
        It can be useful to see the color coded files for differences at a glance or track changes
        in a file. You should consider disabling all of the web development plugins. Disabling
        other tools is up to you as well. Now select \texttt{Next: Feature Plugins}
      \item
        Again, the choices here are yours. If you like vim, then maybe the vim plugin is up your
        alley. The markdown plugin can be useful as well. You do not need the TeamCity Integration,
        the Lua integration, nor the Swift integration. Select \texttt{Start using CLion}
    \end{enumerate}
\end{enumerate}

\subsection{Installing the ANTLR Plugin for CLion}
ANTLR has a CLion integration that gives syntax highlighting as well as tool for visualising the
parse tree for a grammar rule and an input.
\begin{enumerate}
  \item
    Launch CLion by going to the application launcher (finder) and typing \lstinline{clion}. This
    should launch CLion.
  \item
    Open the settings window \texttt{CLion $\rightarrow$ Preferences...}
  \item
    Select \texttt{Plugins} from the menu on the left.
  \item
    Click \texttt{Browse Repositories...} below the plugin list.
  \item
    In the new window, type \texttt{antlr} into the search bar at the top.
  \item
    From the list select \lstinline{ANTLR v4 grammar plugin}.
  \item
    Click \texttt{Install} in the right pane and accept the notice.
  \item
    After the install bar ends click the \texttt{Restart CLion} button that should have replaced
    the \texttt{Install} button.
\end{enumerate}

\subsection{Installing ANTLR Generator}
If you'd like to manually generate a listener or visitor you need to have the ANTLR generator.
Follow these steps into install it:
\begin{enumerate}
  \item
    Make the destination directory. I would suggest putting this in \lstinline{<INSTALL_DIR>/bin}
    since the CMake projects will already automatically download a copy there and duplicating
    this seems wasteful. If you want to put it elsewhere though, you can. We'll refer to this new
    directory (e.g. \lstinline{<INSTALL_DIR>/bin}) as \lstinline{ANTLR_BIN}.
    \begin{lstlisting}
      mkdir <ANTLR_BIN>
      curl http://www.antlr.org/download/antlr-4.7.1-complete.jar > <ANTLR_BIN>/antlr-4.7.1-complete.jar
    \end{lstlisting}
  \item
    Now we can make it easy to use. Add the following lines to your \lstinline{~/.bash_profile}:
    \begin{lstlisting}
      # C415 Antlr Generator
      export CLASSPATH="<ANTLR_BIN>/antlr-4.7.1-complete.jar:$CLASSPATH"
      alias antlr4="java -Xmx500M org.antlr.v4.Tool"
      alias grun='java org.antlr.v4.gui.TestRig'
    \end{lstlisting}
    Restart your terminal for things to take effect. Now these commands should produce useful help
    outputs:
    \begin{lstlisting}
      antlr4
      grun
    \end{lstlisting}
\end{enumerate}

\subsection{Installing the Tester}
This is the tool you'll be using for testing your solutions locally. You'll be building it yourself
so that any changes later are easily obtainable.

If you encounter issues, please log them on the \href{https://github.com/cmput415/Tester/issues}
{GitHub issue tracker} or, if you want to, submit a pull request and we'll review it!
\begin{enumerate}
  \item
    The testing tool uses C++17 features (that have been experimental since C++11) that the default
    clang installation doesn't ship with by default. While it \textit{is} possible to build with
    Clang, the process and invocation is much more involved. Why stress ourselves when GCC can save
    us the trouble?
    \begin{lstlisting}
      brew install gcc
    \end{lstlisting}
  \item
    We'll build the tool in your home directory.
    \begin{lstlisting}
      cd $HOME
      git clone https://github.com/cmput415/Tester.git
    \end{lstlisting}
  \item
    Next we'll make the build directory.
    \begin{lstlisting}
      cd Tester
      mkdir build
    \end{lstlisting}
  \item
    Now, the configure and generate step.
    \begin{lstlisting}
      cd build
      cmake .. -DCMAKE_CXX_COMPILER="g++-8" -DCMAKE_C_COMPILER="gcc-8"
    \end{lstlisting}
    The flags on the end ensure we're using GCC to compile this.
  \item
    Finally, build the project.
    \begin{lstlisting}
      make
    \end{lstlisting}
  \item
    We could refer directly to the executable everytime, but it's probably easier to just have it
    on our path. Add these lines to the end of \lstinline{~/.bash_profile}.
    \begin{lstlisting}
      # C415 Testing Utility
      export PATH="$HOME/Tester/bin/:$PATH"
    \end{lstlisting}
  \item
    Restart your terminal to have changes take effect. Test the command to make sure it works.
    \begin{lstlisting}
      tester --help
    \end{lstlisting}
\end{enumerate}
For more info about organising your tests and creating a configuration (though templates will be
provided with your assignments) you can check
\href{https://github.com/cmput415/Tester/blob/master/README.md}{the Tester README}.

\subsection{Testing Your Environment}
Everything should be setup! Let's just make sure.
\begin{enumerate}
  \item
    Download \href{https://webdocs.cs.ualberta.ca/\%7Ec415/setup/static/demo.tar.gz} {this
    tarball}.
  \item
    Extract it via
    \begin{lstlisting}
      tar -xzf demo.tar.gz
    \end{lstlisting}
  \item
    Change into the extracted directory.
    \begin{lstlisting}
      cd demo
    \end{lstlisting}
  \item
    Make the project.
    \begin{lstlisting}
      make
    \end{lstlisting}
  \item
    The project should compile with no warnings or errors. If there's a problem, you may have set
    something up incorrectly. Otherwise, congrats!
  \item
    If you'd like to start playing with the tools this is a good opportunity! Here are a few
    challenges you can attempt with the files provided:
    \begin{enumerate}
      \item
        There's no input file provided for the tool. Examine the grammar and C++ source and
        figure out how to construct an appropriate input where ANTLR doesn't complain about extra
        tokens.
      \item
        Add floats.
        \begin{itemize}
          \item Be careful of lexer rule ordering.
          \item Be careful that \lstinline{6|5} or \lstinline{6a5} are not recognised as floats.
        \end{itemize}
    \end{enumerate}
\end{enumerate}

\subsection{Creating a Personal Project}
We're providing two ways for you to play with ANTLR and C++. The first way uses the Makefile from
the demo you've just done, and the other uses CMake to set up a project using the cmake modules
that are also used by your assgnments.

\subsubsection{Makefile}
First, download \href{https://webdocs.cs.ualberta.ca/\%7Ec415/setup/static/Makefile} {the
Makefile} from the link and put it in your folder. Alternatively you can download straight to your
directory:
\begin{lstlisting}
  curl https://webdocs.cs.ualberta.ca/~c415/setup/static/Makefile > Makefile
\end{lstlisting}
This Makefile is both rather complex and simple. The internals are the complicated part. If you'd
like to understand how the Makefile works then everything is well documented. However, that
complexity makes using it simple! So if you'd prefer to just use the Makefile then we can keep
everything simple.

First things first, your grammars. All grammars need to be in the same directory as the Makefile.
If they aren't, then they won't be detected, generated, built, or linked.

Next, your source files (\lstinline{.cpp} or \lstinline{.h(pp)}) must also be in the same directory
as the Makefile. Again, if they aren't, they won't be detected, built, or linked.

As you can see, this isn't the most scalable of directory structures but it is functional for
playing with ANTLR and C++. To test that it's working, create your grammar file with:
\begin{lstlisting}
  grammar <file_name>;
  <top_rule>: ANYTHING*? EOF;
  ANYTHING: .;
\end{lstlisting}
And the file that has your main in it:
\begin{lstlisting}
  #include "<grammar_name>Parser.h"
  int main() { return 0; }
\end{lstlisting}
You should be able to make it and run the tool (it won't produce any output):
\begin{lstlisting}
  make
  ./tool
\end{lstlisting}
We've also enabled you to use the ANTLR GUI through the Makefile. First, make an input file. Then,
pass it to the Makefile `gui` rule:
\begin{lstlisting}
  echo "this is a test" > test.txt
  make gui grammar=<grammar_name> rule=<top_rule> file=test.txt
\end{lstlisting}
Any grammar in the same directory as the make file can be used in this fashion (including the
\lstinline{.g4} extension is optional). The \lstinline{rule} can be any rule in the grammar, but
usually it makes sense to test your "top level" rule. If the \lstinline{file} option is not
included then the GUI will take input from stdin to parse (type into your terminal). Terminate
your input with EOF (ctrl+d on linux generally).

You're ready to start modifying the grammar and C++ source. Don't be afraid to add new source
files and header files: style will eventually be part of your mark so starting here is a good idea!
Feel free to cannibalise anything you'd like from the demo files.

\subsubsection{CMake (TODO)}

Two separate instructions? Using the makefile (TODO) and another for a base project in CMake +
CLion (also TODO, could just be a near duplicate of ANTLRBase with info about creating assignemnts
removed).

\end{document}
